---
# tasks file for k8s_master


- name: Installing packages on master node
  dnf:
    name: "{{ item }}"
    state: present
  become: yes
  with_items: "{{ master_packages }}" 

- name: Staring & enabling cri-o & kubelet on Master Node
  systemd:
   name: "{{ item }}"    
   state: started
   enabled: yes
   masked: no
   daemon_reload: yes
  become: yes
  with_items: "{{ service_names }}"
  
- name: Firewall configuration
  firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
  become: yes
  with_items: "{{ firewall_serv }}" 
 
- name: Activate masquerade
  firewalld:
    masquerade: yes
    state: enabled
    permanent: true

- name: Creating a repository file for Kubernetes
  file:
   path: /etc/yum.repos.d/kubernetes.repo
   state: touch

- name: Set up the kubernetes repository.
  copy:
    dest: /etc/yum.repos.d/kubernetes.repo
    content: |
        [kubernetes]
        name=Kubernetes
        baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64     
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        exclude=kubelet kubeadm kubectl
  

- name: "Updating config file"
  copy: 
    dest: /etc/sysctl.d/k8s.conf
    content: |
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            net.ipv4.ip_forward                 = 1
            
- name: "Turn off swap"
  shell: "swapoff -a"


- name: "Cmmenting Swap in /etc/fstab file"
  replace:
    path: /etc/fstab
    regexp: '^[^#](.*swap*)'
    replace: '#\1'  

- name: "Changing parameters for kernel"
  command: "sysctl --system"
  
  
- name: Set up the cri-o repository.
  copy:
    dest: /etc/modules-load.d/crio.conf
    content: |
        overlay
        br_netfilter

- name: "Allow Network Ports in Firewalld 1"
  firewalld:
    permanent: yes
    immediate: yes
    port: "{{item.port}}/{{item.proto}}"
    state: enabled 
  with_items: "{{ ports }}"

- name: Enabling Bridge Firewall Rule
  shell: "echo '1' > /proc/sys/net/bridge/bridge-nf-call-iptables"     

- name: Allow Network Ports in Firewalld 2
  firewalld:
   port: "{{item.port}}/{{item.proto}}"
   state: enabled
   permanent: yes
   immediate: yes
  with_items: "{{ ports_master }}"
  
- name: FirewallD rules worker
  firewalld:
   permanent: yes
   immediate: yes
   rich_rule: "{{ item }}"
   state: enabled
  with_items: "{{ rules_workers }}"

- name: Enabling Bridge Firewall Rule
  shell: "echo '1' > /proc/sys/net/bridge/bridge-nf-call-iptables"

- name: reload
  service:
    name: firewalld
    state: reloaded
    
- name: Pulling images required for setting up a Kubernetes cluster
  shell: kubeadm config images pull  
  
- name: Initializing Kubernetes cluster
  shell: kubeadm init --ignore-preflight-errors=NumCPU --pod-network-cidr={{cidr_v}}

- name: Copying required files
  shell: |
   mkdir -p $HOME/.kube
   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
   sudo chown $(id -u):$(id -g) $HOME/.kube/config
   
- name: Install flannel dns
  shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

  
- name: ingress controller deploy
  shell: "kubectl apply -f https://raw.githubusercontent.com/haproxytech/kubernetes-ingress/master/deploy/haproxy-ingress.yaml"  
  

- name: Creating token for Slave
  command: kubeadm token create  --print-join-command
  register: token

- name: Storing Logs and Generated token for future purpose.
  local_action: copy content={{ token.stdout }} dest={{ token_file }}
   
- name: Cleaning Caches on RAM
  shell: echo 3 > /proc/sys/vm/drop_caches
  
- name: Restarting the Firewalld service 
  systemd:
    name: firewalld
    state: restarted
  become: yes
